<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‡Ÿæ”¶è¨˜éŒ„ç³»çµ± - GClaudeä¼æ¥­ç®¡ç†ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .revenue-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .form-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .revenue-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #28a745;
        }
        .expense-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid #dc3545;
        }
        .bonus-calculator {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .achievement-status {
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
        }
        .achievement-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }
        .achievement-warning {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            color: white;
        }
        .record-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            border-left: 4px solid #007bff;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .photo-upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .photo-upload-area:hover {
            border-color: #007bff;
            background-color: #f8f9fa;
        }
        .photo-preview {
            max-width: 100px;
            max-height: 100px;
            object-fit: cover;
            border-radius: 5px;
            margin: 5px;
        }
        .bonus-formula {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
        }
        .formula-text {
            font-family: monospace;
            font-size: 0.9em;
        }
    </style>
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/employee">
                <i class="fas fa-chart-line me-2"></i>ç‡Ÿæ”¶è¨˜éŒ„ç³»çµ±
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/employee">
                    <i class="fas fa-arrow-left me-1"></i>è¿”å›ä¸»é 
                </a>
            </div>
        </div>
    </nav>

    <div class="container my-4">
        <!-- é é¢æ¨™é¡Œ -->
        <div class="row mb-4">
            <div class="col-12">
                <h2 class="text-center">
                    <i class="fas fa-money-bill-wave text-success me-2"></i>ç‡Ÿæ”¶è¨˜éŒ„ç³»çµ±
                </h2>
                <p class="text-muted text-center">è¨˜éŒ„æ¯æ—¥ç‡Ÿæ¥­é¡ï¼Œè‡ªå‹•è¨ˆç®—çé‡‘</p>
            </div>
        </div>

        <!-- ç‡Ÿæ”¶è¨˜éŒ„è¡¨å–® -->
        <div class="form-section">
            <h5 class="mb-4">
                <i class="fas fa-plus-circle text-primary me-2"></i>æ–°å¢ç‡Ÿæ”¶è¨˜éŒ„
            </h5>
            
            <form id="revenueForm">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <label for="revenueDate" class="form-label">é¸æ“‡æ—¥æœŸ</label>
                        <input type="date" class="form-control" id="revenueDate" required>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="storeSelect" class="form-label">åˆ†åº—</label>
                        <select class="form-control" id="storeSelect" required>
                            <option value="">è«‹é¸æ“‡åˆ†åº—</option>
                        </select>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label for="bonusType" class="form-label">çé‡‘é¡åˆ¥</label>
                        <select class="form-control" id="bonusType" required onchange="updateBonusFormula()">
                            <option value="">è«‹é¸æ“‡é¡åˆ¥</option>
                            <option value="weekday">å¹³æ—¥çé‡‘</option>
                            <option value="holiday">å‡æ—¥çé‡‘</option>
                        </select>
                    </div>
                </div>

                <div class="row mb-3">
                    <div class="col-md-6 mb-3">
                        <label for="orderCount" class="form-label">è¨‚å–®æ•¸é‡</label>
                        <input type="number" class="form-control" id="orderCount" min="0" required onchange="calculateAverageOrder()">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="averageOrder" class="form-label">è¨‚å–®å¹³å‡ï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰</label>
                        <input type="number" class="form-control" id="averageOrder" readonly>
                    </div>
                </div>

                <!-- æ”¶å…¥é …ç›® -->
                <div class="mb-4">
                    <h6><i class="fas fa-plus-circle text-success me-2"></i>æ”¶å…¥é …ç›®</h6>
                    <div id="revenueItems">
                        <!-- æ”¶å…¥é …ç›®å°‡å‹•æ…‹ç”Ÿæˆ -->
                    </div>
                    <div class="text-center mt-3">
                        <div class="row">
                            <div class="col-md-4">
                                <strong>åŸå§‹ç¸½é¡: NT$ <span id="originalRevenue">0</span></strong>
                            </div>
                            <div class="col-md-4">
                                <strong>æ‰£é™¤æœå‹™è²»: NT$ <span id="serviceFeeTotal">0</span></strong>
                            </div>
                            <div class="col-md-4">
                                <strong>æ·¨æ”¶å…¥ç¸½é¡: NT$ <span id="totalRevenue">0</span></strong>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æ”¯å‡ºé …ç›® -->
                <div class="mb-4">
                    <h6><i class="fas fa-minus-circle text-danger me-2"></i>æ”¯å‡ºé …ç›®</h6>
                    <div id="expenseItems">
                        <!-- æ”¯å‡ºé …ç›®å°‡å‹•æ…‹ç”Ÿæˆ -->
                    </div>
                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="addExpenseItem()">
                        <i class="fas fa-plus me-1"></i>æ–°å¢æ”¯å‡ºé …ç›®
                    </button>
                    <div class="text-center mt-3">
                        <strong>æ”¯å‡ºç¸½é¡: NT$ <span id="totalExpense">0</span></strong>
                    </div>
                </div>

                <!-- å‚™è¨» -->
                <div class="mb-3">
                    <label for="notes" class="form-label">å‚™è¨»æ¬„ä½</label>
                    <textarea class="form-control" id="notes" rows="3" placeholder="è«‹è¼¸å…¥å‚™è¨»ä¿¡æ¯"></textarea>
                </div>

                <!-- ç…§ç‰‡ä¸Šå‚³ -->
                <div class="mb-4">
                    <label class="form-label">ä¸Šå‚³ç…§ç‰‡</label>
                    <div class="row mb-2">
                        <div class="col-md-3">
                            <span class="badge bg-info">å»¢æ²¹å›æ”¶</span>
                        </div>
                        <div class="col-md-3">
                            <span class="badge bg-warning">å™¨å…·ä¿é¤Š</span>
                        </div>
                        <div class="col-md-3">
                            <span class="badge bg-primary">è²¨æ¬¾å–®æ“š</span>
                        </div>
                        <div class="col-md-3">
                            <span class="badge bg-secondary">å…¶ä»–é–‹æ”¯</span>
                        </div>
                    </div>
                    <div class="photo-upload-area" onclick="document.getElementById('photoInput').click()">
                        <i class="fas fa-camera fa-2x text-muted mb-2"></i>
                        <p class="text-muted">é»æ“Šä¸Šå‚³ç›¸é—œç…§ç‰‡</p>
                    </div>
                    <input type="file" id="photoInput" accept="image/*" multiple style="display: none;">
                    <div id="photoPreview" class="mt-3"></div>
                </div>

                <div class="text-center">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-save me-2"></i>æäº¤ç‡Ÿæ”¶è¨˜éŒ„
                    </button>
                </div>
            </form>
        </div>

        <!-- çé‡‘è¨ˆç®—å™¨ -->
        <div class="bonus-calculator" id="bonusCalculator" style="display: none;">
            <h5><i class="fas fa-calculator me-2"></i>çé‡‘è¨ˆç®—çµæœ</h5>
            
            <!-- çé‡‘é ç®—æ–‡å­—èªªæ˜ -->
            <div class="bonus-formula" id="bonusFormula">
                <h6>çé‡‘è¨ˆç®—å…¬å¼ï¼š</h6>
                <div class="formula-text" id="formulaText">
                    è«‹é¸æ“‡çé‡‘é¡åˆ¥ä»¥é¡¯ç¤ºè¨ˆç®—å…¬å¼
                </div>
            </div>
            
            <div class="row mt-3">
                <div class="col-md-6">
                    <div class="mb-2">
                        <strong>æ”¶å…¥ç¸½é¡ï¼ˆæ‰£é™¤æœå‹™è²»ï¼‰:</strong> NT$ <span id="calculatedRevenue">0</span>
                    </div>
                    <div class="mb-2">
                        <strong>æ”¯å‡ºç¸½é¡:</strong> NT$ <span id="calculatedExpense">0</span>
                    </div>
                    <div class="mb-2">
                        <strong>æ·¨æ”¶å…¥:</strong> NT$ <span id="netRevenue">0</span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-2">
                        <strong>çé‡‘é–€æª»:</strong> NT$ <span id="bonusThreshold">0</span>
                    </div>
                    <div class="mb-2">
                        <strong>çé‡‘æ¯”ä¾‹:</strong> <span id="bonusRate">0</span>%
                    </div>
                    <div class="achievement-status" id="achievementStatus">
                        <!-- é”æˆç‹€æ…‹ -->
                    </div>
                </div>
            </div>
        </div>

        <!-- ç‡Ÿæ”¶è¨˜éŒ„åˆ—è¡¨ -->
        <div class="form-section">
            <h5 class="mb-4">
                <i class="fas fa-list me-2"></i>æ‰€æœ‰åˆ†åº—çš„ç‡Ÿæ”¶è¨˜éŒ„ï¼ˆå„åˆ†åº—é¡¯ç¤º3ç­†ï¼‰
            </h5>
            
            <!-- ç¯©é¸å™¨ -->
            <div class="row mb-3">
                <div class="col-md-4">
                    <label class="form-label">ç¯©é¸åˆ†åº—</label>
                    <select class="form-control" id="filterStore">
                        <option value="">æ‰€æœ‰åˆ†åº—</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">ç¯©é¸æ—¥æœŸ</label>
                    <input type="date" class="form-control" id="filterDate">
                </div>
                <div class="col-md-4">
                    <label class="form-label">&nbsp;</label>
                    <div>
                        <button class="btn btn-outline-primary" onclick="loadRevenueRecords()">
                            <i class="fas fa-search me-1"></i>ç¯©é¸
                        </button>
                        <button class="btn btn-outline-secondary" onclick="resetFilters()">
                            <i class="fas fa-undo me-1"></i>é‡ç½®
                        </button>
                    </div>
                </div>
            </div>

            <!-- è¨˜éŒ„åˆ—è¡¨ -->
            <div id="revenueRecords">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">è¼‰å…¥ä¸­...</span>
                    </div>
                    <p class="mt-2">è¼‰å…¥ç‡Ÿæ”¶è¨˜éŒ„ä¸­...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- ç¢ºèªä½œå»¢æ¨¡æ…‹æ¡† -->
    <div class="modal fade" id="voidModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-trash-alt me-2"></i>ç¢ºèªä½œå»¢è¨˜éŒ„
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="voidRecordInfo"></div>
                    <div class="mt-3">
                        <label for="voidReason" class="form-label">ä½œå»¢åŸå› </label>
                        <textarea class="form-control" id="voidReason" rows="3" placeholder="è«‹è¼¸å…¥ä½œå»¢åŸå› " required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-danger" id="confirmVoidBtn">ç¢ºèªä½œå»¢</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentVoidId = null;
        let stores = [];
        let uploadedPhotos = [];

        // é è¨­æ”¶å…¥é¡åˆ¥ï¼ˆæŒ‰ç³»çµ±é‚è¼¯æ–‡ä»¶è¨­å®šï¼‰
        const defaultRevenueCategories = [
            { name: "ç¾å ´ç‡Ÿæ¥­é¡", serviceFee: 0, includeInBonus: true },
            { name: "ç·šä¸Šé»é¤", serviceFee: 0, includeInBonus: true },
            { name: "ç†Šè²“é»é¤", serviceFee: 0.35, includeInBonus: true },
            { name: "uberé»é¤", serviceFee: 0.35, includeInBonus: true },
            { name: "å»¢æ²¹å›æ”¶", serviceFee: 0, includeInBonus: false }
        ];

        // é è¨­æ”¯å‡ºé¡åˆ¥
        const defaultExpenseCategories = ["ç“¦æ–¯", "æ°´é›»", "æˆ¿ç§Ÿ", "è²¨æ¬¾", "æ¸…æ½”è²»", "å…¶ä»–"];

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            loadStores();
            initializeForm();
            loadRevenueRecords();
            
            // è¨­å®šä»Šæ—¥æ—¥æœŸç‚ºé è¨­å€¼
            document.getElementById('revenueDate').valueAsDate = new Date();
        });

        // é©—è­‰ç™»å…¥ç‹€æ…‹
        function checkAuth() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = '/';
                return;
            }
        }

        // è¼‰å…¥åˆ†åº—åˆ—è¡¨
        async function loadStores() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch('/api/stores', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    stores = result.data;
                    populateStoreSelects();
                } else {
                    console.error('è¼‰å…¥åˆ†åº—å¤±æ•—:', result.message);
                    // å¦‚æœAPIå¤±æ•—ï¼Œä½¿ç”¨é è¨­åˆ†åº—
                    stores = [
                        { id: 1, name: 'ç¸½å…¬å¸' },
                        { id: 2, name: 'å…§å£¢å¿ å­åº—' },
                        { id: 3, name: 'æ¡ƒåœ’é¾å®‰åº—' }
                    ];
                    populateStoreSelects();
                }
            } catch (error) {
                console.error('è¼‰å…¥åˆ†åº—æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                // ä½¿ç”¨é è¨­åˆ†åº—
                stores = [
                    { id: 1, name: 'ç¸½å…¬å¸' },
                    { id: 2, name: 'å…§å£¢å¿ å­åº—' },
                    { id: 3, name: 'æ¡ƒåœ’é¾å®‰åº—' }
                ];
                populateStoreSelects();
            }
        }

        // å¡«å……åˆ†åº—é¸æ“‡å™¨
        function populateStoreSelects() {
            const storeSelect = document.getElementById('storeSelect');
            const filterStore = document.getElementById('filterStore');
            
            storeSelect.innerHTML = '<option value="">è«‹é¸æ“‡åˆ†åº—</option>';
            filterStore.innerHTML = '<option value="">æ‰€æœ‰åˆ†åº—</option>';
            
            stores.forEach(store => {
                storeSelect.innerHTML += `<option value="${store.id}">${store.name}</option>`;
                filterStore.innerHTML += `<option value="${store.id}">${store.name}</option>`;
            });
        }

        // åˆå§‹åŒ–è¡¨å–®
        function initializeForm() {
            generateRevenueItems();
            
            // ç¶å®šè¡¨å–®æäº¤äº‹ä»¶
            document.getElementById('revenueForm').addEventListener('submit', submitRevenue);
            
            // ç¶å®šç…§ç‰‡ä¸Šå‚³äº‹ä»¶
            document.getElementById('photoInput').addEventListener('change', handlePhotoUpload);
        }

        // ç”Ÿæˆæ”¶å…¥é …ç›®
        function generateRevenueItems() {
            const container = document.getElementById('revenueItems');
            container.innerHTML = '';
            
            defaultRevenueCategories.forEach((category, index) => {
                const serviceFeeText = category.serviceFee > 0 ? ` (æœå‹™è²»${(category.serviceFee * 100)}%)` : '';
                
                container.innerHTML += `
                    <div class="revenue-item">
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                <strong>${category.name}${serviceFeeText}</strong>
                            </div>
                            <div class="col-md-4">
                                <div class="input-group">
                                    <span class="input-group-text">NT$</span>
                                    <input type="number" class="form-control revenue-input" 
                                           id="revenue_${index}" min="0" 
                                           data-service-fee="${category.serviceFee}"
                                           data-include-bonus="${category.includeInBonus}"
                                           onchange="calculateTotals()">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <small class="text-muted">
                                    ${category.includeInBonus ? 'ğŸ’° è¨ˆå…¥çé‡‘' : 'ğŸš« ä¸è¨ˆå…¥çé‡‘'}
                                </small>
                            </div>
                        </div>
                    </div>
                `;
            });
        }

        // æ›´æ–°çé‡‘å…¬å¼èªªæ˜
        function updateBonusFormula() {
            const bonusType = document.getElementById('bonusType').value;
            const formulaText = document.getElementById('formulaText');
            
            if (bonusType === 'weekday') {
                formulaText.innerHTML = `
                    <strong>å¹³æ—¥çé‡‘è¨ˆç®—æ–¹å¼ï¼š</strong><br>
                    ä¾‹å¦‚ï¼šç¾å ´$10,000 + ç†Šè²“$10,000(æœå‹™è²»35%) + UBER$10,000(æœå‹™è²»35%) = ?<br>
                    è¨ˆç®—ï¼š10,000 + 6,500 + 6,500 = 23,000<br>
                    <span class="text-warning">å¤§æ–¼ 13,000 çš„ 30% å€¼å°±æ˜¯ä»Šå¤©å¹³æ—¥çš„çé‡‘</span><br>
                    çé‡‘ = 23,000 Ã— 30% = 6,900
                `;
            } else if (bonusType === 'holiday') {
                formulaText.innerHTML = `
                    <strong>å‡æ—¥çé‡‘è¨ˆç®—æ–¹å¼ï¼š</strong><br>
                    ä¾‹å¦‚ï¼šç¾å ´$10,000 + ç†Šè²“$10,000(æœå‹™è²»35%) + UBER$10,000(æœå‹™è²»35%) = ?<br>
                    è¨ˆç®—ï¼š10,000 + 6,500 + 6,500 = 23,000<br>
                    <span class="text-warning">é …ç›®åŠ ç¸½çš„é‡‘é¡å¤§æ–¼æˆ–ç­‰æ–¼ 0 ç„¶å¾Œå–å‡º 38% çš„å€¼</span><br>
                    çé‡‘ = 23,000 Ã— 38% = 8,740
                `;
            } else {
                formulaText.innerHTML = 'è«‹é¸æ“‡çé‡‘é¡åˆ¥ä»¥é¡¯ç¤ºè¨ˆç®—å…¬å¼';
            }
            
            calculateTotals();
        }

        // æ–°å¢æ”¯å‡ºé …ç›®
        function addExpenseItem() {
            const container = document.getElementById('expenseItems');
            
            container.innerHTML += `
                <div class="expense-item">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <select class="form-control expense-category" required>
                                <option value="">è«‹é¸æ“‡æ”¯å‡ºé¡åˆ¥</option>
                                ${defaultExpenseCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}
                            </select>
                        </div>
                        <div class="col-md-4">
                            <div class="input-group">
                                <span class="input-group-text">NT$</span>
                                <input type="number" class="form-control expense-input" 
                                       min="0" onchange="calculateTotals()">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <button type="button" class="btn btn-outline-danger btn-sm" 
                                    onclick="removeExpenseItem(this)">
                                <i class="fas fa-trash-alt"></i> ç§»é™¤
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // ç§»é™¤æ”¯å‡ºé …ç›®
        function removeExpenseItem(btn) {
            btn.closest('.expense-item').remove();
            calculateTotals();
        }

        // è¨ˆç®—ç¸½é¡
        function calculateTotals() {
            let originalTotal = 0;  // åŸå§‹ç¸½é¡
            let totalRevenue = 0;   // æ‰£é™¤æœå‹™è²»å¾Œç¸½é¡
            let bonusEligibleRevenue = 0;  // è¨ˆå…¥çé‡‘çš„æ”¶å…¥
            let serviceFeeTotal = 0;  // æœå‹™è²»ç¸½é¡
            
            document.querySelectorAll('.revenue-input').forEach(input => {
                const amount = parseFloat(input.value) || 0;
                const serviceFee = parseFloat(input.dataset.serviceFee) || 0;
                const includeBonus = input.dataset.includeBonus === 'true';
                
                originalTotal += amount;
                const serviceFeeAmount = amount * serviceFee;
                const netAmount = amount - serviceFeeAmount;
                
                serviceFeeTotal += serviceFeeAmount;
                totalRevenue += netAmount;
                
                if (includeBonus) {
                    bonusEligibleRevenue += netAmount;
                }
            });
            
            // è¨ˆç®—æ”¯å‡ºç¸½é¡
            let totalExpense = 0;
            document.querySelectorAll('.expense-input').forEach(input => {
                totalExpense += parseFloat(input.value) || 0;
            });
            
            // æ›´æ–°é¡¯ç¤º
            document.getElementById('originalRevenue').textContent = originalTotal.toLocaleString();
            document.getElementById('serviceFeeTotal').textContent = serviceFeeTotal.toLocaleString();
            document.getElementById('totalRevenue').textContent = totalRevenue.toLocaleString();
            document.getElementById('totalExpense').textContent = totalExpense.toLocaleString();
            
            // è¨ˆç®—å¹³å‡å®¢å–®åƒ¹
            calculateAverageOrder();
            
            // è¨ˆç®—çé‡‘
            calculateBonus(bonusEligibleRevenue, totalExpense);
        }

        // è¨ˆç®—çé‡‘
        function calculateBonus(revenue, expense) {
            const bonusType = document.getElementById('bonusType').value;
            const netRevenue = revenue - expense;
            
            let bonusThreshold = 0;
            let bonusRate = 0;
            let calculatedBonus = 0;
            
            if (bonusType === 'weekday') {
                // å¹³æ—¥çé‡‘ï¼šå¤§æ–¼13000çš„30%
                bonusThreshold = 13000;
                bonusRate = 30;
                if (netRevenue > bonusThreshold) {
                    calculatedBonus = netRevenue * 0.3;
                }
            } else if (bonusType === 'holiday') {
                // å‡æ—¥çé‡‘ï¼šå¤§æ–¼ç­‰æ–¼0çš„38%
                bonusThreshold = 0;
                bonusRate = 38;
                if (netRevenue >= bonusThreshold) {
                    calculatedBonus = netRevenue * 0.38;
                }
            }
            
            // æ›´æ–°çé‡‘è¨ˆç®—å™¨
            const calculator = document.getElementById('bonusCalculator');
            const achievementStatus = document.getElementById('achievementStatus');
            
            if (bonusType) {
                calculator.style.display = 'block';
                
                document.getElementById('calculatedRevenue').textContent = revenue.toLocaleString();
                document.getElementById('calculatedExpense').textContent = expense.toLocaleString();
                document.getElementById('netRevenue').textContent = netRevenue.toLocaleString();
                document.getElementById('bonusThreshold').textContent = bonusThreshold.toLocaleString();
                document.getElementById('bonusRate').textContent = bonusRate;
                
                if (calculatedBonus > 0) {
                    achievementStatus.className = 'achievement-status achievement-success';
                    achievementStatus.innerHTML = `ğŸ‰ ä»Šæ—¥çé‡‘ï¼šNT$ ${calculatedBonus.toLocaleString()}`;
                } else {
                    const shortage = bonusThreshold - netRevenue;
                    achievementStatus.className = 'achievement-status achievement-warning';
                    achievementStatus.innerHTML = `âš ï¸ æœªé”æ¨™ï¼Œå·®è· NT$ ${shortage.toLocaleString()}`;
                }
            } else {
                calculator.style.display = 'none';
            }
        }

        // è¨ˆç®—è¨‚å–®å¹³å‡
        function calculateAverageOrder() {
            const totalRevenue = parseFloat(document.getElementById('totalRevenue').textContent.replace(/,/g, '')) || 0;
            const orderCount = parseFloat(document.getElementById('orderCount').value) || 0;
            
            if (orderCount > 0 && totalRevenue > 0) {
                const average = totalRevenue / orderCount;
                document.getElementById('averageOrder').value = Math.round(average);
            } else {
                document.getElementById('averageOrder').value = '';
            }
        }

        // è™•ç†ç…§ç‰‡ä¸Šå‚³
        function handlePhotoUpload(event) {
            const files = Array.from(event.target.files);
            const preview = document.getElementById('photoPreview');
            
            files.forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = document.createElement('img');
                        img.src = e.target.result;
                        img.className = 'photo-preview';
                        img.title = file.name;
                        preview.appendChild(img);
                    };
                    reader.readAsDataURL(file);
                    
                    uploadedPhotos.push(file);
                }
            });
        }

        // æäº¤ç‡Ÿæ”¶è¨˜éŒ„
        async function submitRevenue(event) {
            event.preventDefault();
            
            try {
                const formData = collectFormData();
                
                if (!validateFormData(formData)) {
                    return;
                }
                
                const token = localStorage.getItem('token');
                const response = await fetch('/api/revenue', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('ç‡Ÿæ”¶è¨˜éŒ„æäº¤æˆåŠŸï¼Telegramé€šçŸ¥å·²ç™¼é€', 'success');
                    resetForm();
                    loadRevenueRecords();
                } else {
                    showAlert('ç‡Ÿæ”¶è¨˜éŒ„æäº¤å¤±æ•—ï¼š' + result.message, 'danger');
                }
            } catch (error) {
                showAlert('æäº¤æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message, 'danger');
            }
        }

        // æ”¶é›†è¡¨å–®è³‡æ–™
        function collectFormData() {
            const revenueItems = [];
            document.querySelectorAll('.revenue-input').forEach((input, index) => {
                const amount = parseFloat(input.value) || 0;
                if (amount > 0) {
                    revenueItems.push({
                        category: defaultRevenueCategories[index].name,
                        amount: amount,
                        serviceFee: defaultRevenueCategories[index].serviceFee,
                        includeInBonus: defaultRevenueCategories[index].includeInBonus
                    });
                }
            });
            
            const expenseItems = [];
            document.querySelectorAll('.expense-item').forEach(item => {
                const category = item.querySelector('.expense-category').value;
                const amount = parseFloat(item.querySelector('.expense-input').value) || 0;
                if (category && amount > 0) {
                    expenseItems.push({
                        category: category,
                        amount: amount
                    });
                }
            });
            
            // è¨ˆç®—çé‡‘è³‡æ–™
            const bonusType = document.getElementById('bonusType').value;
            const totalRevenue = parseFloat(document.getElementById('totalRevenue').textContent.replace(/,/g, '')) || 0;
            const totalExpense = parseFloat(document.getElementById('totalExpense').textContent.replace(/,/g, '')) || 0;
            const netRevenue = totalRevenue - totalExpense;
            
            let bonusAmount = 0;
            let shortageAmount = 0;
            let achievementRate = 0;
            let target = 0;
            
            if (bonusType === 'weekday') {
                target = 13000;
                if (netRevenue > target) {
                    bonusAmount = netRevenue * 0.3;
                    achievementRate = 1;
                } else {
                    shortageAmount = target - netRevenue;
                    achievementRate = netRevenue / target;
                }
            } else if (bonusType === 'holiday') {
                target = 0;
                if (netRevenue >= target) {
                    bonusAmount = netRevenue * 0.38;
                    achievementRate = 1;
                } else {
                    shortageAmount = target - netRevenue;
                    achievementRate = 0;
                }
            }
            
            return {
                date: document.getElementById('revenueDate').value,
                store_id: parseInt(document.getElementById('storeSelect').value),
                bonus_type: bonusType,
                order_count: parseInt(document.getElementById('orderCount').value) || 0,
                revenue_items: revenueItems,
                expense_items: expenseItems,
                notes: document.getElementById('notes').value,
                total_revenue: totalRevenue,
                total_expense: totalExpense,
                net_revenue: netRevenue,
                bonus_amount: bonusAmount,
                shortage_amount: shortageAmount,
                achievement_rate: achievementRate,
                target: target,
                photos: uploadedPhotos.map(file => file.name) // å¯¦éš›ä¸Šå‚³é‚è¼¯éœ€è¦å–®ç¨è™•ç†
            };
        }

        // é©—è­‰è¡¨å–®è³‡æ–™
        function validateFormData(data) {
            if (!data.date) {
                showAlert('è«‹é¸æ“‡æ—¥æœŸ', 'warning');
                return false;
            }
            
            if (!data.store_id) {
                showAlert('è«‹é¸æ“‡åˆ†åº—', 'warning');
                return false;
            }
            
            if (!data.bonus_type) {
                showAlert('è«‹é¸æ“‡çé‡‘é¡åˆ¥', 'warning');
                return false;
            }
            
            if (data.revenue_items.length === 0) {
                showAlert('è«‹è‡³å°‘è¼¸å…¥ä¸€é …æ”¶å…¥', 'warning');
                return false;
            }
            
            return true;
        }

        // é‡ç½®è¡¨å–®
        function resetForm() {
            document.getElementById('revenueForm').reset();
            document.getElementById('photoPreview').innerHTML = '';
            document.getElementById('bonusCalculator').style.display = 'none';
            uploadedPhotos = [];
            
            // é‡ç½®æ”¶å…¥è¼¸å…¥æ¡†
            document.querySelectorAll('.revenue-input').forEach(input => {
                input.value = '';
            });
            
            // é‡ç½®æ”¯å‡ºé …ç›®
            document.getElementById('expenseItems').innerHTML = '';
            addExpenseItem();
            
            // é‡ç½®ç¸½é¡é¡¯ç¤º
            document.getElementById('originalRevenue').textContent = '0';
            document.getElementById('serviceFeeTotal').textContent = '0';
            document.getElementById('totalRevenue').textContent = '0';
            document.getElementById('totalExpense').textContent = '0';
            
            // è¨­å®šä»Šæ—¥æ—¥æœŸ
            document.getElementById('revenueDate').valueAsDate = new Date();
        }

        // è¼‰å…¥ç‡Ÿæ”¶è¨˜éŒ„
        async function loadRevenueRecords() {
            try {
                const token = localStorage.getItem('token');
                const storeFilter = document.getElementById('filterStore').value;
                const dateFilter = document.getElementById('filterDate').value;
                
                let url = '/api/revenue/records';
                const params = new URLSearchParams();
                if (storeFilter) params.append('store_id', storeFilter);
                if (dateFilter) params.append('date', dateFilter);
                if (params.toString()) url += '?' + params.toString();
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    renderRevenueRecords(result.data);
                } else {
                    showAlert('è¼‰å…¥è¨˜éŒ„å¤±æ•—ï¼š' + result.message, 'danger');
                }
            } catch (error) {
                console.error('è¼‰å…¥è¨˜éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                // é¡¯ç¤ºç©ºç‹€æ…‹è€Œä¸æ˜¯éŒ¯èª¤
                document.getElementById('revenueRecords').innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                        <p class="text-muted">æš«ç„¡ç‡Ÿæ”¶è¨˜éŒ„æˆ–é€£æ¥æœå‹™å™¨å¤±æ•—</p>
                    </div>
                `;
            }
        }

        // æ¸²æŸ“ç‡Ÿæ”¶è¨˜éŒ„
        function renderRevenueRecords(records) {
            const container = document.getElementById('revenueRecords');
            
            if (!records || records.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                        <p class="text-muted">å°šç„¡ç‡Ÿæ”¶è¨˜éŒ„</p>
                    </div>
                `;
                return;
            }
            
            // æŒ‰åˆ†åº—åˆ†çµ„ï¼Œæ¯åº—æœ€å¤šé¡¯ç¤º3ç­†
            const groupedRecords = {};
            records.forEach(record => {
                const storeName = record.store_name || 'æœªçŸ¥åˆ†åº—';
                if (!groupedRecords[storeName]) {
                    groupedRecords[storeName] = [];
                }
                if (groupedRecords[storeName].length < 3) {
                    groupedRecords[storeName].push(record);
                }
            });
            
            container.innerHTML = '';
            Object.entries(groupedRecords).forEach(([storeName, storeRecords]) => {
                container.innerHTML += `<h6 class="mt-4 mb-3"><i class="fas fa-store me-2"></i>${storeName}</h6>`;
                
                storeRecords.forEach(record => {
                    const recordDate = new Date(record.date).toLocaleDateString('zh-TW');
                    const submitTime = new Date(record.created_at).toLocaleString('zh-TW');
                    const bonusTypeText = record.bonus_type === 'holiday' ? 'å‡æ—¥çé‡‘' : 'å¹³æ—¥çé‡‘';
                    const isAchieved = record.bonus_amount > 0;
                    
                    container.innerHTML += `
                        <div class="record-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <div class="d-flex align-items-center mb-2">
                                        <h6 class="mb-0 me-3">${recordDate}</h6>
                                        <small class="text-muted">(æäº¤ä¼ºæœå™¨ï¼š${submitTime})</small>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-8">
                                            <p class="mb-1">
                                                <span class="badge bg-info me-2">${bonusTypeText}</span>
                                                ${isAchieved ? 
                                                    `<span class="badge bg-success">é”æ¨™ NT$ ${record.bonus_amount?.toLocaleString()}</span>` :
                                                    `<span class="badge bg-warning">æœªé”æ¨™ å·®è· NT$ ${record.shortage_amount?.toLocaleString() || 0}</span>`
                                                }
                                            </p>
                                            <p class="mb-1">
                                                <small class="text-muted">
                                                    ç‡Ÿæ”¶ï¼šNT$ ${record.total_revenue?.toLocaleString() || 0} | 
                                                    æ”¯å‡ºï¼šNT$ ${record.total_expense?.toLocaleString() || 0} | 
                                                    æ·¨æ”¶å…¥ï¼šNT$ ${((record.total_revenue || 0) - (record.total_expense || 0)).toLocaleString()}
                                                </small>
                                            </p>
                                            ${record.notes ? `<p class="text-muted small mb-0"><strong>å‚™è¨»ï¼š</strong>${record.notes}</p>` : ''}
                                        </div>
                                        <div class="col-md-4 text-end">
                                            <button class="btn btn-outline-danger btn-sm" 
                                                    onclick="showVoidModal(${record.id}, '${recordDate}', '${storeName}')">
                                                <i class="fas fa-trash-alt"></i> ä½œå»¢
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            });
        }

        // é‡ç½®ç¯©é¸å™¨
        function resetFilters() {
            document.getElementById('filterStore').value = '';
            document.getElementById('filterDate').value = '';
            loadRevenueRecords();
        }

        // é¡¯ç¤ºä½œå»¢ç¢ºèªæ¨¡æ…‹æ¡†
        function showVoidModal(recordId, date, storeName) {
            currentVoidId = recordId;
            
            document.getElementById('voidRecordInfo').innerHTML = `
                <div class="alert alert-warning">
                    <p><strong>ç¢ºå®šè¦ä½œå»¢ä»¥ä¸‹è¨˜éŒ„å—ï¼Ÿ</strong></p>
                    <p><strong>æ—¥æœŸï¼š</strong>${date}</p>
                    <p><strong>åˆ†åº—ï¼š</strong>${storeName}</p>
                    <p class="text-muted small mb-0">æ­¤æ“ä½œç„¡æ³•å¾©åŸï¼Œå°‡ç™¼é€Telegramé€šçŸ¥</p>
                </div>
            `;
            
            const modal = new bootstrap.Modal(document.getElementById('voidModal'));
            modal.show();
            
            // ç¶å®šç¢ºèªæŒ‰éˆ•äº‹ä»¶
            document.getElementById('confirmVoidBtn').onclick = voidRevenueRecord;
        }

        // ä½œå»¢ç‡Ÿæ”¶è¨˜éŒ„
        async function voidRevenueRecord() {
            try {
                const reason = document.getElementById('voidReason').value.trim();
                if (!reason) {
                    showAlert('è«‹è¼¸å…¥ä½œå»¢åŸå› ', 'warning');
                    return;
                }
                
                const token = localStorage.getItem('token');
                const response = await fetch(`/api/revenue/${currentVoidId}/void`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ reason: reason })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('ç‡Ÿæ”¶è¨˜éŒ„å·²ä½œå»¢ï¼ŒTelegramé€šçŸ¥å·²ç™¼é€', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('voidModal')).hide();
                    document.getElementById('voidReason').value = '';
                    loadRevenueRecords();
                } else {
                    showAlert('ä½œå»¢å¤±æ•—ï¼š' + result.message, 'danger');
                }
            } catch (error) {
                showAlert('ä½œå»¢æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message, 'danger');
            }
        }

        // é€šç”¨è­¦å‘Šé¡¯ç¤ºå‡½æ•¸
        function showAlert(message, type = 'info') {
            const alertContainer = document.createElement('div');
            alertContainer.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertContainer.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
            alertContainer.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(alertContainer);
            
            setTimeout(() => {
                if (alertContainer.parentNode) {
                    alertContainer.remove();
                }
            }, 5000);
        }
        
        // åˆå§‹åŒ–æ™‚è‡ªå‹•æ·»åŠ ä¸€å€‹æ”¯å‡ºé …ç›®
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                addExpenseItem();
            }, 500);
        });
    </script>
</body>
</html>