name: ğŸš€ GClaude Enterprise CI/CD Pipeline

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ğŸ“‹ ç¨‹å¼ç¢¼å“è³ªæª¢æŸ¥
  code-quality:
    name: ğŸ“‹ Code Quality Check
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ” Lint Check
        run: npm run lint --if-present

      - name: ğŸ“Š Type Check
        run: npm run typecheck --if-present

      - name: ğŸ”’ Security Audit
        run: npm audit --audit-level=moderate

  # ğŸ§ª æ¸¬è©¦éšæ®µ
  test:
    name: ğŸ§ª Test Suite
    runs-on: ubuntu-latest
    needs: code-quality
    strategy:
      matrix:
        test-type: [unit, integration, api, security]
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ—„ï¸ Setup Database
        run: |
          mkdir -p data
          node -e "require('./database.js')"

      - name: ğŸ§ª Run ${{ matrix.test-type }} Tests
        run: |
          case "${{ matrix.test-type }}" in
            "unit")
              npm test --if-present
              ;;
            "integration")
              npm run test:integration --if-present
              ;;
            "api")
              npm start &
              sleep 10
              node scripts/comprehensive-api-test.js
              ;;
            "security")
              node scripts/security-audit.js
              ;;
          esac

      - name: ğŸ“Š Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.test-type }}
          path: |
            test-results/
            coverage/
            logs/

  # ğŸŒ ç€è¦½å™¨æ¸¬è©¦
  browser-tests:
    name: ğŸŒ Browser Compatibility Tests
    runs-on: ubuntu-latest
    needs: test
    strategy:
      matrix:
        browser: [chrome, firefox]
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸŒ Install Browser Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y chromium-browser firefox

      - name: ğŸ—„ï¸ Setup Database
        run: |
          mkdir -p data
          node -e "require('./database.js')"

      - name: ğŸš€ Start Server
        run: |
          npm start &
          sleep 15

      - name: ğŸŒ Run Browser Tests
        run: |
          if [ "${{ matrix.browser }}" = "chrome" ]; then
            node scripts/enhanced-browser-verification.js
          else
            node scripts/comprehensive-cross-browser-test.js
          fi

      - name: ğŸ“¸ Upload Screenshots
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: browser-screenshots-${{ matrix.browser }}
          path: |
            **/screenshots/
            **/*screenshots*/

  # ğŸ³ Dockeræ§‹å»º
  docker-build:
    name: ğŸ³ Docker Build & Test
    runs-on: ubuntu-latest
    needs: [test, browser-tests]
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ³ Build Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          load: true
          tags: gclaude-enterprise:test
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ğŸ§ª Test Docker Container
        run: |
          docker run -d --name test-container \
            -p 3007:3007 \
            -e NODE_ENV=test \
            gclaude-enterprise:test
          
          sleep 30
          
          # å¥åº·æª¢æŸ¥
          curl --fail http://localhost:3007/api/health || exit 1
          
          docker stop test-container
          docker rm test-container

      - name: ğŸ·ï¸ Log in to Container Registry
        if: github.ref == 'refs/heads/main'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¦ Extract Metadata
        if: github.ref == 'refs/heads/main'
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: ğŸš€ Build and Push
        if: github.ref == 'refs/heads/main'
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ğŸš€ éƒ¨ç½²åˆ°å„å¹³å°
  deploy:
    name: ğŸš€ Deploy to Production
    runs-on: ubuntu-latest
    needs: [docker-build]
    if: github.ref == 'refs/heads/main'
    environment: production
    strategy:
      matrix:
        platform: [railway, render]
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸš€ Deploy to ${{ matrix.platform }}
        run: |
          case "${{ matrix.platform }}" in
            "railway")
              if [ -n "${{ secrets.RAILWAY_TOKEN }}" ]; then
                echo "éƒ¨ç½²åˆ° Railway..."
                # Railway CLI éƒ¨ç½²é‚è¼¯
                curl -fsSL https://railway.app/install.sh | sh
                railway login --token ${{ secrets.RAILWAY_TOKEN }}
                railway up --detach
              else
                echo "Railway token not configured, skipping"
              fi
              ;;
            "render")
              if [ -n "${{ secrets.RENDER_API_KEY }}" ]; then
                echo "è§¸ç™¼ Render éƒ¨ç½²..."
                curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK }}" \
                  -H "Authorization: Bearer ${{ secrets.RENDER_API_KEY }}"
              else
                echo "Render API key not configured, skipping"
              fi
              ;;
          esac

  # âœ… éƒ¨ç½²å¾Œé©—è­‰
  post-deploy-verification:
    name: âœ… Post-Deploy Verification
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main'
    steps:
      - name: ğŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: â³ Wait for Deployment
        run: sleep 60

      - name: ğŸ¥ Health Check
        run: |
          URLS=("https://gclaude-enterprise.railway.app" "https://gclaude-enterprise.onrender.com")
          for url in "${URLS[@]}"; do
            echo "æª¢æŸ¥ $url..."
            if curl --fail --max-time 30 "$url/api/health"; then
              echo "âœ… $url å¥åº·æª¢æŸ¥é€šé"
            else
              echo "âŒ $url å¥åº·æª¢æŸ¥å¤±æ•—"
            fi
          done

      - name: ğŸ§ª Smoke Tests
        run: |
          # åŸ·è¡ŒåŸºæœ¬åŠŸèƒ½æ¸¬è©¦
          node -e "
            const axios = require('axios');
            async function smokeTest() {
              const urls = [
                'https://gclaude-enterprise.railway.app',
                'https://gclaude-enterprise.onrender.com'
              ];
              
              for (const url of urls) {
                try {
                  console.log(\`æ¸¬è©¦ \${url}...\`);
                  
                  // å¥åº·æª¢æŸ¥
                  const health = await axios.get(\`\${url}/api/health\`, { timeout: 10000 });
                  console.log(\`âœ… å¥åº·æª¢æŸ¥: \${health.status}\`);
                  
                  // ç™»å…¥æ¸¬è©¦
                  const login = await axios.post(\`\${url}/api/auth/login\`, {
                    username: 'admin',
                    password: 'admin123'
                  }, { timeout: 10000 });
                  console.log(\`âœ… ç™»å…¥æ¸¬è©¦: \${login.status}\`);
                  
                } catch (error) {
                  console.log(\`âŒ \${url} æ¸¬è©¦å¤±æ•—: \${error.message}\`);
                }
              }
            }
            smokeTest();
          "

  # ğŸ“± é€šçŸ¥
  notify:
    name: ğŸ“± Notification
    runs-on: ubuntu-latest
    needs: [post-deploy-verification]
    if: always()
    steps:
      - name: ğŸ“± Send Telegram Notification
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ "${{ needs.post-deploy-verification.result }}" = "success" ]; then
            STATUS="âœ… æˆåŠŸ"
            MESSAGE="ğŸš€ GClaude Enterprise System éƒ¨ç½²æˆåŠŸï¼
            
            ğŸ“Š éƒ¨ç½²è³‡è¨Š:
            â€¢ åˆ†æ”¯: ${{ github.ref_name }}
            â€¢ æäº¤: ${{ github.sha }}
            â€¢ è§¸ç™¼è€…: ${{ github.actor }}
            
            ğŸŒ å¯ç”¨ç¶²å€:
            â€¢ Railway: https://gclaude-enterprise.railway.app
            â€¢ Render: https://gclaude-enterprise.onrender.com
            
            âœ… æ‰€æœ‰æ¸¬è©¦å’Œéƒ¨ç½²æª¢æŸ¥é€šé"
          else
            STATUS="âŒ å¤±æ•—"
            MESSAGE="ğŸš¨ GClaude Enterprise System éƒ¨ç½²å¤±æ•—ï¼
            
            ğŸ“Š éƒ¨ç½²è³‡è¨Š:
            â€¢ åˆ†æ”¯: ${{ github.ref_name }}
            â€¢ æäº¤: ${{ github.sha }}
            â€¢ è§¸ç™¼è€…: ${{ github.actor }}
            
            è«‹æª¢æŸ¥ GitHub Actions æ—¥èªŒä»¥äº†è§£è©³ç´°éŒ¯èª¤è³‡è¨Šã€‚"
          fi
          
          if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
            curl -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
              -H "Content-Type: application/json" \
              -d "{
                \"chat_id\": \"$TELEGRAM_CHAT_ID\",
                \"text\": \"$MESSAGE\",
                \"parse_mode\": \"HTML\"
              }"
          fi